<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<meta name="description" content="">
<meta name="author" content="">

<title>Route to ClickTime</title>

<!-- Bootstrap core CSS -->
<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">

<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<link href="bootstrap/css/ie10-viewport-bug-workaround.css"
	rel="stylesheet">

<!-- Custom styles for this template -->
<link href="bootstrap/css/dashboard.css" rel="stylesheet">

<!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
<!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
<script src="bootstrap/js/ie-emulation-modes-warning.js"></script>

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

<style>
html, body {
	height: 95%;
	margin: 0;
	padding: 0;
}

#map {
	margin-left: 3%;
	margin-top: 2%;
	height: 80%;
}

#right-panel {
	font-family: 'Roboto', 'sans-serif';
	line-height: 30px;
	padding-left: 10px;
	margin-right: 3%;
}

#right-panel select, #right-panel input {
	font-size: 15px;
}

#right-panel select {
	width: 100%;
}

#right-panel i {
	font-size: 12px;
}

#right-panel {
	margin-top: 2%;
	height: 80%;
	float: right;
	width: 390px;
	overflow: auto;
}

@media print {
	#map {
		height: 500px;
		margin: 0;
	}
	#right-panel {
		float: none;
		width: auto;
	}
}
</style>
</head>
<body>

	<nav class="navbar navbar-inverse navbar-fixed-top">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed"
					data-toggle="collapse" data-target="#navbar" aria-expanded="false"
					aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span> <span
						class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>

			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav navbar-left">
					<li><a id="getDirection" data-value="37.785704, -122.396937">
							Destination: ClickTime (282 2nd Street 4th floor, San Francisco,
							CA 94105)</a></li>
						

				</ul>
			</div>
		</div>
	</nav>
	<br />
	<br />

	<div class="container-fluid">
		<div class="row">
			<div class="col-sm-9 col-md-10 main">
				<h2 class="sub-header">Coffe Shops (Nearby ClickTime)</h2>
				<span id="helpBlock" class="help-block">Below list is limited to coffee shops very close(< 3miles) to Clicktime's office, so that Devs can enjoy a hot cup of coffee :) </span>
				<span id="helpBlock" class="help-block">Select any one of the coffee shops or select multiple and click on Get Directions! </span>
				<span id="helpBlock" class="help-block">Directions will be displayed on the right side of the map, including stopovers at selected the coffee shop(s) </span>
				<div class="table-responsive">
					<table class="table table-striped" id="coffeShops">
						<thead>
							<tr>
								<th>#</th>
								<th>Name</th>
								<th>Address</th>
								<th>Select from where to get the coffee and donots</th>

							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<div class="row" style="margin-left: 1%;">
			<!-- Standard button -->
			<div class="col-md-1"><input type="radio" name="transportationMode" value="google.maps.TravelMode.DRIVING" checked> Drive</div>
			<div class="col-md-1"><input type="radio" name="transportationMode" value="google.maps.TravelMode.WALKING" checked> Walk</div> 
  			<div class="col-md-1"><input type="radio" name="transportationMode" value="google.maps.TravelMode.BICYCLING"> Bike </div> 
  			<div class="col-md-1"><input type="radio" name="transportationMode" value="google.maps.TravelMode.TRANSIT"> Transit </div>
  			
		</div>
		<br />
		<div class="row" style="margin-left: 2%;">
			<!-- Standard button -->
			<button type="button" class="btn btn-success" id="getDirections">Get Directions</button>
		</div>
	</div>

	<br />

	<div id="right-panel"></div>

	<div id="map"></div>

	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	
	<!-- Include all compiled plugins (below), or include individual files as needed -->
	<script src="bootstrap/js/bootstrap.min.js"></script>

	<script>
		var map;
		var infowindow;

		//The below function finds which are the coffee shops located nearby the office
		function initMap() {
			var clicktime = {
				lat : 37.785704,
				lng : -122.396937
			};

			map = new google.maps.Map(document.getElementById('map'), {
				center : clicktime,
				zoom : 15
			});

			infowindow = new google.maps.InfoWindow();

			var service = new google.maps.places.PlacesService(map);
			service.nearbySearch({
				location : clicktime,
				radius : 150,
				types : [ 'cafe' ]
			}, callback);
		}

		//Below function populates the list of nearby coffee shops and displays on the UI 
		function callback(results, status) {
			if (status === google.maps.places.PlacesServiceStatus.OK) {
				for (var i = 0; i < results.length; i++) {
					var x = i + 1;
					var checkboxID = results[i].geometry.location.lat() + ','
							+ results[i].geometry.location.lng();

					var tr = '<tr>'
							+ '<td value='+results[i].id+'>'
							+ x
							+ '</td>'
							+ '<td>'
							+ results[i].name
							+ '</td>'
							+'<td>'
							+results[i].vicinity
							+'</td>'
							+ '<td><input type="checkbox" data="'+checkboxID+'" id="'+results[i].id+'" class="coffeShopLocation"></td>'
							+ '</tr>';

					createMarker(results[i]);
					$('#coffeShops').append(tr);
					if (i == 0) {
						$('#' + results[i].id).attr('checked', true);
					}
				}
			}
		}

		//Below function marks the same coffee ships on map 
		function createMarker(place) {
			var placeLoc = place.geometry.location;
			var marker = new google.maps.Marker({
				map : map,
				position : place.geometry.location
			});

			google.maps.event.addListener(marker, 'click', function() {
				infowindow.setContent(place.name);
				infowindow.open(map, this);
			});
		}

	</script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC4bSxQE9ocKWuRCLK-_kbE_iD4KMVa_ck&libraries=places&callback=initMap"></script>
	
	<script>
		$(document).ready(function() {
			/** Click func() to get directions to the office
			*	1. Once the button is clicked, a list of selected coffee shops is built
			*	2. The transportation mode is set
			*	3. User's current location is determined and set as the startAddress
			* 	4. Finally, directions to the destination are calculated	
			**/
			$('#getDirections').click(function() {
				var startAddress;
				var waypts = [];
				var mode=$('input[name="transportationMode"]:checked').val();
				
				var MODE = (function() {
				     var private = {
				    		 "google.maps.TravelMode.DRIVING": google.maps.TravelMode.DRIVING, 
							 "google.maps.TravelMode.WALKING": google.maps.TravelMode.WALKING, 
							 "google.maps.TravelMode.BICYCLING": google.maps.TravelMode.BICYCLING,
							 "google.maps.TravelMode.TRANSIT": google.maps.TravelMode.TRANSIT
				     };

				     return {
				        get: function(name) { return private[name]; }
				    };
				})();

				var transportationMode=MODE.get(mode);
				$('input[class="coffeShopLocation"]:checked').each(function() {
					if ($(this).is(':checked'))
						console.log($(this).attr("data"));
						waypts.push({
					        location: $(this).attr("data"),
					        stopover: true
					      });
				});
				
				
				
				navigator.geolocation.getCurrentPosition(function(position) {
		            var geocoder = new google.maps.Geocoder();
		            geocoder.geocode({
		              "location": new google.maps.LatLng(position.coords.latitude, position.coords.longitude)
		            },
		            function(results, status) {
		              if (status == google.maps.GeocoderStatus.OK){
		                console.log(results[0].formatted_address);
		                startAddress=results[0].formatted_address;
		                initMap1(startAddress,waypts,transportationMode);
		              }
		              else
		                console.log("Unable to retrieve your address<br />");
		            });
		          },
		          function(positionError){
		        	  console.log("Error: " + positionError.message + "<br />");
		          },
		          {
		            enableHighAccuracy: true,
		            timeout: 10 * 1000 // 10 seconds
		          });
				
				
			});
		});

		   
		
		function initMap1(startAddress,waypts,transportationMode) {
						
			var directionsDisplay = new google.maps.DirectionsRenderer;
			var directionsService = new google.maps.DirectionsService;
			var map = new google.maps.Map(document.getElementById('map'), {
				zoom : 7,
				center : {
					
					lat : 37.785704,
					lng : -122.396937
				}
			});
			var infoWindow = new google.maps.InfoWindow({
				map : map
			});

			directionsDisplay.setMap(map);
			directionsDisplay.setPanel(document.getElementById('right-panel'));
			calculateAndDisplayRoute(directionsService, directionsDisplay,startAddress,waypts,transportationMode);

		}

		
		function calculateAndDisplayRoute(directionsService, directionsDisplay,
				startAddress,waypts,transportationMode) {
			var start = String(startAddress);
			
			
			//This is the destination address i.e. ClickTime's office
			var end = "37.785704, -122.396937";
			
			directionsService.route({
				origin : start,
				destination : end,
				waypoints:waypts,
				travelMode : transportationMode
			}, function(response, status) {
				if (status === google.maps.DirectionsStatus.OK) {
					$('#right-panel').html('');
					directionsDisplay.setDirections(response);
				} else {
					window.alert('Directions request failed due to ' + status);
				}
			});
		}

		function handleLocationError(browserHasGeolocation, infoWindow, pos) {
			infoWindow.setPosition(pos);
			infoWindow
					.setContent(browserHasGeolocation ? 'Error: The Geolocation service failed.'
							: 'Error: Your browser doesn\'t support geolocation.');
		}
	</script>
	

</body>
</html>
